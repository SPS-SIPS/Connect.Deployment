name: ${INSTITUTION_NAME:-agro}-sips-connect
services:
  sips-connect:
    image: hanad/sips-connect:1.1.0
    environment:
      - DB_HOST=${DB_HOST:-sips-connect-db}
      - DB_PORT=${DB_PORT:-5432}
    ports:
      - "${SIPS_CONNECT_PORT:-9030}:8080"   # HTTP (existing)
      - "${SIPS_CONNECT_HTTPS_PORT:-9443}:443"   # HTTPS (new)
    env_file:
      - ./.env
    volumes:
      - ./logs:/logs:rw
      - ./certs:/certs:ro
      - ./appsettings.json:/app/appsettings.json:rw
      - ./jsonAdapter.json:/app/jsonAdapter.json:rw
    networks:
      - sips-network
    entrypoint: ["/bin/sh", "-c", "update-ca-certificates && exec dotnet SIPS.Connect.dll"]
  idp:
    image: keycloak/keycloak:26.2.0
    env_file:
      - ./.env
    command:
      - start-dev
      - --import-realm
      - --verbose
      - --https-key-store-file=/opt/keycloak/certs/keycloak.p12
      - --https-key-store-password=${KEYCLOAK_KEYSTORE_PASSWORD}
      - --hostname-strict=false
      - --http-enabled=false
      - --https-port=${IDP_PORT:-8443}
    volumes:
      - ./realm-config:/opt/keycloak/data/import
      - ./certs/keycloak.p12:/opt/keycloak/certs/keycloak.p12:ro
    ports:
      - "${IDP_PORT:-9031}:${IDP_PORT:-8443}"
    networks:
      - sips-network
  promtail:
    image: grafana/promtail:2.9.7
    volumes:
      - ./logs:/var/log/app
      - ./promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml
    networks:
      - sips-network
  grafana:
    image: grafana/grafana:10.4.2
    ports:
      - "${GRAFANA_PORT:-9033}:3000"
    networks:
      - sips-network
    volumes:
      - grafana_data:/var/lib/grafana
  sips-corebank:
    image: hanad/sips-consumer:1.0.8
    ports:
      - "${CB_PORT:-9032}:8080"
    env_file:
      - ./.env
    volumes:
      - ./db.json:/app/db.json:rw
      - ./certs:/certs:ro
    networks:
      - sips-network
volumes:
  grafana_data:
  pg_data:

networks:
  sips-network:
    driver: bridge